{{- bos_token -}}
{%- set system_prompt = "" -%}
{%- set ns = namespace(system_prompt="") -%}
{%- if messages[0]["role"] == "system" -%}
	{%- set ns.system_prompt = messages[0]["content"] -%}
	{%- set messages = messages[1:] -%}
{%- endif -%}
{%- if tools -%}
	{%- set ns.system_prompt = ns.system_prompt + ("\n" if ns.system_prompt else "") + "List of tools: <|tool_list_start|>[" -%}
	{%- for tool in tools -%}
		{%- if tool is not string -%}
			{%- set tool = tool | tojson -%}
		{%- endif -%}
		{%- set ns.system_prompt = ns.system_prompt + tool -%}
		{%- if not loop.last -%}
			{%- set ns.system_prompt = ns.system_prompt + ", " -%}
		{%- endif -%}
	{%- endfor -%}
	{%- set ns.system_prompt = ns.system_prompt + "]<|tool_list_end|>" -%}
{%- endif -%}
{%- if ns.system_prompt -%}
	{{- "<|im_start|>system\n" + ns.system_prompt + "<|im_end|>\n" -}}
{%- endif -%}
{%- for message in messages -%}
	{{- "<|im_start|>" + message["role"] + "\n" -}}
	{%- set content = message["content"] if message["content"] else "" -%}
	{%- if content is not string -%}
		{%- set content = content | tojson -%}
	{%- endif -%}
	{%- if message["role"] == "tool" -%}
		{%- set content = "<|tool_response_start|>" + content + "<|tool_response_end|>" -%}
	{%- elif message["role"] == "assistant" and "tool_calls" in message and message["tool_calls"] -%}
		{%- set ns_tc = namespace(result="") -%}
		{%- for tc in message["tool_calls"] -%}
			{%- if not loop.first -%}{%- set ns_tc.result = ns_tc.result + ", " -%}{%- endif -%}
			{%- set args = tc["function"]["arguments"] -%}
			{%- set ns_tc.result = ns_tc.result + '{"name": "' + tc["function"]["name"] + '", "arguments": ' -%}
			{%- if args is string -%}
				{%- set ns_tc.result = ns_tc.result + args -%}
			{%- else -%}
				{%- set ns_tc.result = ns_tc.result + (args | tojson) -%}
			{%- endif -%}
			{%- if tc.get("id") -%}
				{%- set ns_tc.result = ns_tc.result + ', "id": "' + tc["id"] + '"' -%}
			{%- endif -%}
			{%- set ns_tc.result = ns_tc.result + "}" -%}
		{%- endfor -%}
		{%- set content = "<|tool_call_start|>[" + ns_tc.result + "]<|tool_call_end|>" + content -%}
	{%- endif -%}
	{{- content + "<|im_end|>\n" -}}
{%- endfor -%}
{%- if add_generation_prompt -%}
	{{- "<|im_start|>assistant\n" -}}
{%- endif -%}
