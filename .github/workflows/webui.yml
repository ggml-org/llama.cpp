name: WebUI

on:
    push:
        paths:
            - ".github/workflows/webui.yml"
            - "tools/server/webui/**"

jobs:
    setup:
        name: Setup environment
        permissions:
            contents: read

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: "tools/server/webui/package-lock.json"

            - name: Cache node_modules
              uses: actions/cache@v4
              id: cache-node-modules
              with:
                  path: tools/server/webui/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('tools/server/webui/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Install dependencies
              if: steps.cache-node-modules.outputs.cache-hit != 'true'
              run: npm ci
              working-directory: tools/server/webui

    check:
        needs: setup
        name: Run type checking and linting
        permissions:
            contents: read

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: tools/server/webui/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('tools/server/webui/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Run type checking
              run: npm run check
              working-directory: tools/server/webui

            - name: Run linting
              run: npm run lint
              working-directory: tools/server/webui

    build:
        needs: check
        name: Build application
        permissions:
            contents: read

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: tools/server/webui/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('tools/server/webui/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Build application
              run: npm run build
              working-directory: tools/server/webui

    tests:
        needs: build
        name: Run tests
        permissions:
            contents: read

        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: tools/server/webui/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('tools/server/webui/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: Install Playwright browsers
              run: npx playwright install --with-deps
              working-directory: tools/server/webui

            - name: Build Storybook
              run: npm run build-storybook
              working-directory: tools/server/webui

            - name: Run Client tests
              run: npm run test:client
              working-directory: tools/server/webui

            - name: Run Server tests
              run: npm run test:server
              working-directory: tools/server/webui

            - name: Run UI tests
              run: npm run test:ui
              working-directory: tools/server/webui

            - name: Run E2E tests
              run: npm run test:e2e
              working-directory: tools/server/webui
