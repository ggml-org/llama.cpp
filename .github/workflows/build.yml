name: CI

on:
  workflow_dispatch: # allows manual triggering
  push:
    branches:
      - master
    paths: ['.github/workflows/build.yml', '.github/workflows/build-linux-cross.yml', '**/CMakeLists.txt', '**/.cmake', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cu', '**/*.cuh', '**/*.swift', '**/*.m', '**/*.metal', '**/*.comp']
  pull_request:
    types: [opened, synchronize, reopened]
    paths: ['.github/workflows/build.yml', '.github/workflows/build-linux-cross.yml', '**/CMakeLists.txt', '**/.cmake', '**/*.h', '**/*.hpp', '**/*.c', '**/*.cpp', '**/*.cu', '**/*.cuh', '**/*.swift', '**/*.m', '**/*.metal', '**/*.comp']

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref && github.ref || github.run_id }}
  cancel-in-progress: true

env:
  GGML_NLOOP: 3
  GGML_N_THREADS: 1
  LLAMA_LOG_COLORS: 1
  LLAMA_LOG_PREFIX: 1
  LLAMA_LOG_TIMESTAMPS: 1

jobs:
  macOS-latest-cmake-arm64:
    runs-on: macos-14

    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v4

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.16
        with:
          key: macOS-latest-cmake-arm64
          evict-old-files: 1d

      - name: Dependencies
        id: depends
        continue-on-error: true
        run: |
          brew update
          brew install curl

      - name: Build
        id: cmake_build
        run: |
          sysctl -a
          cmake -B build \
            -DCMAKE_BUILD_RPATH="@loader_path" \
            -DLLAMA_FATAL_WARNINGS=ON \
            -DGGML_METAL_USE_BF16=ON \
            -DGGML_METAL_EMBED_LIBRARY=ON \
            -DGGML_RPC=ON
          cmake --build build --config Release -j $(sysctl -n hw.logicalcpu)

      - name: Test
        id: cmake_test
        run: |
          cd build
          ctest -L 'main|curl' --verbose --timeout 900

  # macOS-latest-cmake-x64:
  #   runs-on: macos-13

  #   steps:
  #     - name: Clone
  #       id: checkout
  #       uses: actions/checkout@v4

  #     - name: ccache
  #       uses: hendrikmuhs/ccache-action@v1.2.16
  #       with:
  #         key: macOS-latest-cmake-x64
  #         evict-old-files: 1d

  #     - name: Dependencies
  #       id: depends
  #       continue-on-error: true
  #       run: |
  #         brew update
  #         brew install curl

  #     - name: Build
  #       id: cmake_build
  #       run: |
  #         sysctl -a
  #         # Metal is disabled due to intermittent failures with Github runners not having a GPU:
  #         # https://github.com/ggml-org/llama.cpp/actions/runs/8635935781/job/23674807267#step:5:2313
  #         cmake -B build \
  #           -DCMAKE_BUILD_RPATH="@loader_path" \
  #           -DLLAMA_FATAL_WARNINGS=ON \
  #           -DGGML_METAL=OFF \
  #           -DGGML_RPC=ON
  #         cmake --build build --config Release -j $(sysctl -n hw.logicalcpu)

  #     - name: Test
  #       id: cmake_test
  #       run: |
  #         cd build
  #         ctest -L main --verbose --timeout 900

  # build-linux-cross:
  #   uses: ./.github/workflows/build-linux-cross.yml
